<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ„Ø±ÙÙŠØ¨ - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <!-- Firebase SDK (Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
        body { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; justify-content:center; align-items:center; min-height:100vh; }
        #app { width:100%; max-width:500px; height:700px; background:white; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.2); position:relative; overflow:hidden; display:flex; flex-direction:column; }
        .auth-container { position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; justify-content:center; align-items:center; padding:20px; }
        .auth-box { width:100%; max-width:350px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); padding:30px; border-radius:20px; box-shadow:0 15px 35px rgba(0,0,0,0.2); }
        .auth-box h2 { color:#333; text-align:center; margin-bottom:25px; font-size:24px; }
        .auth-box input { width:100%; padding:12px 15px; margin:8px 0; border:1px solid #ddd; border-radius:10px; font-size:15px; }
        .auth-box input:focus { border-color:#667eea; outline:none; box-shadow:0 0 0 3px rgba(102,126,234,0.1); }
        .auth-box button { width:100%; padding:12px; background:#667eea; color:white; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer; margin-top:15px; }
        .auth-box button:hover { background:#5a67d8; transform:translateY(-2px); }
        .link-btn { background:transparent !important; color:#667eea !important; border:1px solid #667eea !important; margin-top:10px; }
        .link-btn:hover { background:#f0f3ff !important; transform:none !important; }
        .hidden { display:none !important; }
        .error { color:#e74c3c; font-size:13px; margin:5px 0; text-align:right; }
        .success { color:#27ae60; font-size:13px; margin:5px 0; }
    </style>
</head>
<body>
    <div id="app">
        <div id="authContainer" class="auth-container">
            <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
            <div id="loginContainer" class="auth-box">
                <div style="text-align:center; margin-bottom:25px;">
                    <h1 style="color:#667eea; font-size:40px; margin-bottom:5px;">ØªÙ„Ø±ÙÙŠØ¨</h1>
                    <p style="color:#666;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ ØªÙ„Ø±ÙÙŠØ¨</p>
                </div>
                <input type="text" id="loginUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <div id="loginError" class="error"></div>
                <button onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
                <button class="link-btn" onclick="showSignup()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            </div>

            <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ -->
            <div id="signupContainer" class="auth-box hidden">
                <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
                <input type="text" id="signupFullname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø´Ø®ØµÙŠ">
                <input type="text" id="signupUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (5 Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)">
                <input type="email" id="signupEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                <input type="password" id="signupPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <input type="password" id="signupConfirm" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <div id="signupError" class="error"></div>
                <div id="signupSuccess" class="success"></div>
                <button onclick="handleSignUp()">ØªØ³Ø¬ÙŠÙ„</button>
                <button class="link-btn" onclick="showLogin()">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</button>
            </div>
        </div>
    </div>

    <script>
        // -------------------- Firebase --------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDRCtfuYrEdnuKUsWu_79N0",
            authDomain: "tttrt-b8c5a.firebaseapp.com",
            databaseURL: "https://tttrt-b8c5a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tttrt-b8c5a",
            storageBucket: "tttrt-b8c5a.appspot.com",
            messagingSenderId: "975123752593",
            appId: "1:975123752593:web:e591e930af101968875560"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // -------------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ --------------------
        function showLogin() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('signupContainer').classList.add('hidden');
        }
        function showSignup() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('signupContainer').classList.remove('hidden');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·ØŒ 5 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)
        function isValidUsername(username) {
            return /^[A-Za-z0-9_]{5,}$/.test(username);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ (Ø¨Ø¯ÙˆÙ† Firebase Authentication)
        async function handleSignUp() {
            const fullName = document.getElementById('signupFullname').value.trim();
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirm = document.getElementById('signupConfirm').value.trim();

            // ØªÙØ±ÙŠØº Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            document.getElementById('signupError').innerText = '';
            document.getElementById('signupSuccess').innerText = '';

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„
            if (!fullName || !username || !password || !confirm) {
                document.getElementById('signupError').innerText = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©';
                return;
            }
            if (!isValidUsername(username)) {
                document.getElementById('signupError').innerText = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: 5 Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£Ùˆ Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
                return;
            }
            if (password.length < 6) {
                document.getElementById('signupError').innerText = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
                return;
            }
            if (password !== confirm) {
                document.getElementById('signupError').innerText = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©';
                return;
            }

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const snapshot = await db.ref('users').orderByChild('username').equalTo(username).once('value');
                if (snapshot.exists()) {
                    document.getElementById('signupError').innerText = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„';
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
                const newUserRef = db.ref('users').push();
                const uid = newUserRef.key;
                const userData = {
                    uid: uid,
                    fullName: fullName,
                    username: username,
                    email: email,
                    password: password,  // Ù†Øµ Ø¹Ø§Ø¯ÙŠ (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ÙÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
                    photoURL: '',
                    bio: '',
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };

                await newUserRef.set(userData);
                // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙØ±ÙŠØ¯Ø©
                await db.ref(`usernames/${username}`).set(uid);

                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ localStorage
                localStorage.setItem('currentUser', JSON.stringify(userData));

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø«Ù… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                document.getElementById('signupSuccess').innerText = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ...';
                setTimeout(() => {
                    window.location.href = 'app.html';
                }, 1500);
            } catch (error) {
                console.error(error);
                document.getElementById('signupError').innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerText = '';

            if (!username || !password) {
                errorDiv.innerText = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
                return;
            }

            try {
                const snapshot = await db.ref('users').orderByChild('username').equalTo(username).once('value');
                if (!snapshot.exists()) {
                    errorDiv.innerText = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                    return;
                }

                let userData;
                snapshot.forEach(child => userData = child.val());

                if (userData.password !== password) {
                    errorDiv.innerText = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                    return;
                }

                // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
                await db.ref(`users/${userData.uid}/lastLogin`).set(new Date().toISOString());

                // Ø­ÙØ¸ ÙÙŠ localStorage
                localStorage.setItem('currentUser', JSON.stringify(userData));

                // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                window.location.href = 'app.html';
            } catch (error) {
                console.error(error);
                errorDiv.innerText = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            }
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø®Ø²Ù† Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø©
        (function() {
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                window.location.href = 'app.html';
            }
        })();
    </script>
</body>
</html>
