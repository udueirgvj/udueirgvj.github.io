<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الدردشة</title>

<style>
*{box-sizing:border-box;font-family:Tahoma}

body{
margin:0;
background:linear-gradient(135deg,#0f172a,#020617);
color:white;
}

/* الهيدر */
.header{
background:#020617;
padding:12px;
text-align:center;
font-weight:bold;
border-bottom:1px solid #1f2937;
position:sticky;
top:0;
}

.logout{
margin-top:6px;
background:#ef4444;
border:none;
padding:6px 12px;
color:white;
border-radius:8px;
cursor:pointer;
}

/* الرسائل */
#messages{
height:78vh;
overflow-y:auto;
padding:10px;
}

.msg{
background:#1e293b;
padding:10px;
margin:6px 0;
border-radius:10px;
}

/* صندوق الإرسال */
form{
display:flex;
position:fixed;
bottom:0;
width:100%;
background:#020617;
padding:8px;
}

form input{
flex:1;
padding:12px;
border:none;
border-radius:10px;
background:#1f2937;
color:white;
}

form button{
width:90px;
margin-left:6px;
border:none;
border-radius:10px;
background:#22c55e;
color:white;
font-size:15px;
}
</style>
</head>

<body>

<div class="header">
أهلاً بك : <span id="topUser"></span>
<br>
<button class="logout" onclick="logout()">تسجيل الخروج</button>
</div>

<div id="messages"></div>

<form onsubmit="sendMessage(event)">
<input id="messageInput" placeholder="اكتب رسالة...">
<button>إرسال</button>
</form>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* التحقق من تسجيل الدخول */
let user = localStorage.getItem("chatUser");

if(!user){
    window.location="login.html";
}

document.getElementById("topUser").innerText = user;

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDRCtfuYrEdnuKUsWu_79N0",
  authDomain: "tttrt-b8c5a.firebaseapp.com",
  databaseURL: "https://tttrt-b8c5a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tttrt-b8c5a",
  storageBucket: "tttrt-b8c5a.appspot.com",
  messagingSenderId: "975123752593",
  appId: "1:975123752593:web:e591e930af101968875560"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* إرسال رسالة */
function sendMessage(e){
    e.preventDefault();
    let input=document.getElementById("messageInput");
    let msg=input.value.trim();
    if(msg==="") return;

    db.ref("messages").push({
        user:user,
        text:msg,
        time:new Date().toLocaleTimeString()
    });

    input.value="";
}

/* استقبال الرسائل مع تجاهل الرسائل التالفة */
const messagesDiv=document.getElementById("messages");

db.ref("messages").on("child_added", function(snapshot){

    const m = snapshot.val();

    // تجاهل أي رسالة ناقصة (هي التي كانت تظهر undefined)
    if(!m || !m.user || !m.text || !m.time){
        return;
    }

    let div=document.createElement("div");
    div.className="msg";
    div.innerHTML="<b>"+m.user+"</b><br>"+m.text+
    "<br><small style='color:gray'>"+m.time+"</small>";

    messagesDiv.appendChild(div);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
});

/* تسجيل الخروج */
function logout(){
    localStorage.removeItem("chatUser");
    window.location="login.html";
}
</script>

</body>
</html>
